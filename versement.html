<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SODAMA - Versements</title>
<style>
body { font-family: Arial; margin:0; background:#f4f4f4; color:#0a3d62;}
.navbar { display:flex; justify-content:space-between; align-items:center; background:#0a3d62; padding:10px 20px; color:white;}
.navbar .logo { font-size:1.5rem; font-weight:bold;}
.navbar ul { display:flex; list-style:none; gap:15px; }
.navbar ul li a { color:white; text-decoration:none; padding:8px 15px; border-radius:5px; font-weight:bold;}
.navbar ul li a:hover { background:white; color:#0a3d62;}
.menu-toggle { display:none; flex-direction:column; cursor:pointer;}
.menu-toggle span { width:25px; height:3px; background:white; margin:3px 0;}
@media(max-width:768px){
  .menu-toggle{display:flex;}
  .navbar ul{display:none; flex-direction:column; background:#0a3d62; width:200px; position:absolute; top:60px; right:0; padding:10px;}
  .navbar ul.active{display:flex;}
}
.container { width:95%; max-width:900px; margin:20px auto; background:white; padding:20px; border-radius:10px; }
h2 { text-align:center; margin-bottom:20px; }
.balance-section { margin-bottom:30px; padding:15px; background:#e8f4f8; border-radius:8px; border-left:5px solid #0a3d62; }
.balance-grid { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:10px; }
.balance-item { text-align:center; padding:10px; background:white; border-radius:5px; }
.balance-item strong { display:block; font-size:1.2em; color:#0a3d62; }
input, select, textarea, button { width:100%; padding:10px; margin:8px 0; border-radius:5px; border:1px solid #aaa; }
button { background:#0a3d62; color:white; border:none; cursor:pointer; font-weight:bold; }
button:hover { background:#074267; }
table { width:100%; border-collapse:collapse; margin-top:15px; }
th, td { border:1px solid #aaa; padding:10px; text-align:center; }
th { background:#0a3d62; color:white; }
.action-btn { padding:6px 10px; color:white; border:none; cursor:pointer; border-radius:4px; margin:0 2px; }
.edit { background:orange; }
.delete { background:red; }
.accordion-btn { width:100%; background:#0a3d62; color:white; padding:12px; font-size:1.1rem; border:none; border-radius:8px; cursor:pointer; margin-top:15px; text-align:left; }
.accordion-content { display:none; margin-top:10px; border:2px solid #0a3d62; padding:15px; border-radius:8px; }
#downloadPdfBtn { margin:10px auto; display:block; background:#0a3d62; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; }
.total-row { font-weight:bold; background:#dfeaff; }
</style>
</head>
<body>
<nav class="navbar">
  <div class="logo">SODAMA</div>
  <div class="menu-toggle" id="mobile-menu"><span></span><span></span><span></span></div>
  <ul id="nav-links">
    <li><a href="index.html">Accueil</a></li>
    <li><a href="ciment.html">Ciment</a></li>
    <li><a href="transport.html">Transport</a></li>
    <li><a href="rapport.html">Rapport</a></li>
    <li><a href="versement.html">Versement</a></li>
  </ul>
</nav>

<div class="container">
<h2>Gestion des Versements</h2>

<!-- SOLDES EN TEMPS R√âEL -->
<div class="balance-section">
  <h3>üîÑ Soldes Disponibles (mise √† jour automatique)</h3>
  <div class="balance-grid">
    <div class="balance-item">
      <span>Ciment</span>
      <strong id="cimentDisponible">0 FCFA</strong>
    </div>
    <div class="balance-item">
      <span>Transport</span>
      <strong id="transportDisponible">0 FCFA</strong>
    </div>
  </div>
</div>

<label>Date :</label>
<input type="date" id="date">

<label>Type :</label>
<select id="type">
  <option value="ciment">Ciment</option>
  <option value="transport">Transport</option>
</select>

<label>Montant :</label>
<input type="number" id="montant" placeholder="Entrez le montant..." step="0.01">

<label>Description :</label>
<textarea id="description" rows="3"></textarea>

<button type="button" id="saveBtn">Enregistrer</button>

<div id="versementContainer"></div>
<button id="downloadPdfBtn">T√©l√©charger PDF</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
const URL_GLOBAL = "https://script.google.com/macros/s/AKfycbzhJNpg-lQt0pPz2RdKPU86_LWuvo1ubDJJyWWhQ_CJUcennw5SEhlIWntC3GBi_655hQ/exec";
document.getElementById("mobile-menu").onclick = () => document.getElementById("nav-links").classList.toggle("active");

let versements = [], cimentData = [], transportData = [];
let editRowIndex = null;

function getMonthName(m){ return ["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"][m]; }
function formatDate(d){ return new Date(d).toISOString().split('T')[0]; }
function formatFCFA(val){ return Number(val).toLocaleString('fr-FR') + " FCFA"; }

// CHARGER TOUTES LES DONN√âES
async function loadAllData(){
    try {
        console.log("üì• Chargement Versements...");
        const [versRes, cimentRes, transportRes] = await Promise.all([
            fetch(`${URL_GLOBAL}?type=versement`),
            fetch(`${URL_GLOBAL}?type=ciment`),
            fetch(`${URL_GLOBAL}?type=transport`)
        ]);
        
        versements = await versRes.json();
        cimentData = await cimentRes.json();
        transportData = await transportRes.json();
        
        console.log("‚úÖ Versements:", versements.length, "lignes");
        console.log("‚úÖ Ciment:", cimentData.length, "lignes");
        console.log("‚úÖ Transport:", transportData.length, "lignes");
        
        // Convertir versements en format compatible
        versements = versements.map(r => ({
            row: r.row,
            date: r.values[0],
            type: r.values[1],
            montant: parseFloat(r.values[2]) || 0,
            description: r.values[3] || ""
        }));
        
        updateBalances();
        renderVersements();
    } catch(e) {
        console.error("‚ùå Erreur chargement:", e);
        document.getElementById("versementContainer").innerHTML = "<p style='text-align:center;color:red;'>Erreur chargement donn√©es</p>";
    }
}

// SOLDES DISPONIBLES
function updateBalances(){
    const beneficeCimentTotal = cimentData.reduce((sum, r) => sum + (parseFloat(r.values[5]) || 0), 0);
    const beneficeTransportTotal = transportData.reduce((sum, r) => sum + (parseFloat(r.values[5]) || 0), 0);
    
    const versementsCiment = versements.filter(v => v.type === "ciment").reduce((sum, v) => sum + v.montant, 0);
    const versementsTransport = versements.filter(v => v.type === "transport").reduce((sum, v) => sum + v.montant, 0);
    
    document.getElementById("cimentDisponible").textContent = formatFCFA(beneficeCimentTotal - versementsCiment);
    document.getElementById("transportDisponible").textContent = formatFCFA(beneficeTransportTotal - versementsTransport);
}

// RENDRE VERSMENTS PAR MOIS
function renderVersements(){
    const container = document.getElementById("versementContainer");
    container.innerHTML = "";
    
    if(versements.length === 0){
        container.innerHTML = "<p style='text-align:center;'>Aucun versement enregistr√©</p>";
        return;
    }
    
    const grouped = {};
    versements.forEach(v => {
        const d = new Date(v.date);
        const monthKey = `${getMonthName(d.getMonth())} ${d.getFullYear()}`;
        if(!grouped[monthKey]) grouped[monthKey] = { ciment: [], transport: [] };
        grouped[monthKey][v.type].push(v);
    });

    for(const month in grouped){
        const types = grouped[month];
        const btn = document.createElement("button");
        btn.className = "accordion-btn";
        btn.textContent = `Versements du mois : ${month}`;
        const content = document.createElement("div");
        content.className = "accordion-content";

        for(const typeName of ["ciment", "transport"]){
            const rows = types[typeName];
            if(rows.length === 0) continue;
            
            let totalMontant = 0;
            let html = `<h3>${typeName.toUpperCase()}</h3>
                        <table>
                          <thead>
                            <tr>
                              <th>Date</th>
                              <th>Montant</th>
                              <th>Description</th>
                              <th>Modifier</th>
                              <th>Supprimer</th>
                            </tr>
                          </thead>
                          <tbody>`;
            
            rows.forEach(v => {
                totalMontant += v.montant;
                html += `<tr>
                  <td>${formatDate(v.date)}</td>
                  <td>${formatFCFA(v.montant)}</td>
                  <td>${v.description}</td>
                  <td><button class="action-btn edit" onclick="editVersement(${v.row})">Modifier</button></td>
                  <td><button class="action-btn delete" onclick="deleteVersement(${v.row})">Supprimer</button></td>
                </tr>`;
            });
            
            html += `<tr class="total-row">
              <td>Total ${typeName}</td>
              <td>${formatFCFA(totalMontant)}</td>
              <td colspan="3"></td>
            </tr></tbody></table>`;
            
            content.innerHTML += html;
        }

        btn.onclick = () => {
            content.style.display = content.style.display === "block" ? "none" : "block";
        };
        container.appendChild(btn);
        container.appendChild(content);
    }
}

// ‚úÖ FONCTION MODIFIER - GLOBALE
window.editVersement = function(row){
    const v = versements.find(x => x.row === row);
    if(v){
        document.getElementById("date").value = formatDate(v.date);
        document.getElementById("type").value = v.type;
        document.getElementById("montant").value = v.montant;
        document.getElementById("description").value = v.description;
        editRowIndex = row;
        console.log("‚úèÔ∏è √âdition versement:", row);
    }
};

// ‚úÖ FONCTION SUPPRIMER - GLOBALE
window.deleteVersement = async function(row){
    if(!confirm("Supprimer ce versement ?")) return;
    
    try{
        console.log("üóëÔ∏è Suppression versement:", row);
        const res = await fetch(`${URL_GLOBAL}?type=versement&action=delete&index=${row}`);
        const responseText = await res.text();
        console.log("‚úÖ R√©ponse Apps Script:", responseText);
        
        if(responseText === "OK"){
            console.log("‚úÖ Versement supprim√© !");
            loadAllData();
        } else {
            alert("Erreur serveur: " + responseText);
        }
    } catch(e){
        console.error("‚ùå Erreur suppression versement:", e);
        alert("Erreur r√©seau: " + e.message);
    }
};

// ENREGISTRER VERSMENT
document.getElementById("saveBtn").onclick = async function(){
    const date = document.getElementById("date").value;
    const type = document.getElementById("type").value;
    const montant = parseFloat(document.getElementById("montant").value);
    const description = document.getElementById("description").value;

    if(!date || !montant){ alert("Date et montant obligatoires"); return; }

    const data = { date, type, montant, description };
    let url = `${URL_GLOBAL}?type=versement`;
    if(editRowIndex) url += `&edit=${editRowIndex}`;

    try {
        console.log("üíæ Enregistrement versement:", editRowIndex ? "MODIF" : "NOUVELLE");
        await fetch(url, { 
            method: "POST", 
            body: JSON.stringify(data),
            headers: {'Content-Type': 'application/json'}
        });
        editRowIndex = null;
        
        document.getElementById("date").value = "";
        document.getElementById("montant").value = "";
        document.getElementById("description").value = "";
        
        loadAllData();
        console.log("‚úÖ Versement enregistr√© !");
    } catch(e) {
        console.error("‚ùå Erreur sauvegarde:", e);
        alert("Erreur enregistrement: " + e.message);
    }
};

// PDF EXPORT
document.getElementById("downloadPdfBtn").onclick = async () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "pt", "a4");
    const element = document.getElementById("versementContainer");
    
    const canvas = await html2canvas(element, { scale: 2 });
    const img = canvas.toDataURL("image/png");
    const pdfWidth = doc.internal.pageSize.getWidth();
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
    
    doc.addImage(img, "PNG", 0, 0, pdfWidth, pdfHeight);
    doc.save("versements_sodama.pdf");
};

// INITIALISATION
loadAllData();
</script>
</body>
</html>
