<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SODAMA - Versements</title>

<style>
body { font-family: Arial; margin:0; background:#f4f4f4; color:#0a3d62;}
.navbar { display:flex; justify-content:space-between; align-items:center; background:#0a3d62; padding:10px 20px; color:white;}
.navbar .logo { font-size:1.5rem; font-weight:bold;}
.navbar ul { display:flex; list-style:none; gap:15px; }
.navbar ul li a { color:white; text-decoration:none; padding:8px 15px; border-radius:5px; font-weight:bold;}
.navbar ul li a:hover { background:white; color:#0a3d62;}

.menu-toggle { display:none; flex-direction:column; cursor:pointer;}
.menu-toggle span { width:25px; height:3px; background:white; margin:3px 0;}

@media(max-width:768px){
  .menu-toggle{display:flex;}
  .navbar ul{display:none; flex-direction:column; background:#0a3d62; width:200px; position:absolute; top:60px; right:0; padding:10px;}
  .navbar ul.active{display:flex;}
}

.container { width:95%; max-width:900px; margin:20px auto; background:white; padding:20px; border-radius:10px; }

h2 { text-align:center; margin-bottom:20px; }

input, select, textarea, button {
  width:100%; padding:10px; margin:8px 0; border-radius:5px; border:1px solid #aaa;
}

button { background:#0a3d62; color:white; border:none; cursor:pointer; font-weight:bold; }
button:hover { background:#074267; }

table { width:100%; border-collapse:collapse; margin-top:15px; }
th, td { border:1px solid #aaa; padding:10px; text-align:center; }
th { background:#0a3d62; color:white; }

.action-btn { padding:6px 10px; color:white; border:none; cursor:pointer; border-radius:4px; }
.edit { background:orange; }
.delete { background:red; }

.accordion-btn {
  width:100%; background:#0a3d62; color:white; padding:12px;
  font-size:1.1rem; border:none; border-radius:8px; cursor:pointer;
  margin-top:15px; text-align:left;
}

.accordion-content {
  display:none; margin-top:10px; border:2px solid #0a3d62; padding:15px; border-radius:8px;
}

.caisse-box {
  margin-top:8px; padding:10px; background:#dfeaff; border-left:5px solid #0a3d62;
  font-weight:bold; display:flex; justify-content:space-between;
}
</style>
</head>

<body>

<nav class="navbar">
  <div class="logo">SODAMA</div>
  <div class="menu-toggle" id="mobile-menu"><span></span><span></span><span></span></div>
  <ul id="nav-links">
    <li><a href="index.html">Accueil</a></li>
    <li><a href="ciment.html">Ciment</a></li>
    <li><a href="transport.html">Transport</a></li>
    <li><a href="rapport.html">Rapport</a></li>
    <li><a href="versement.html">Versement</a></li>
  </ul>
</nav>

<div class="container">
<h2>Gestion des Versements</h2>

<label>Date :</label>
<input type="date" id="date">

<label>Type :</label>
<select id="type">
  <option value="ciment">Ciment</option>
  <option value="transport">Transport</option>
</select>

<label>Montant :</label>
<input type="number" id="montant" placeholder="Entrez le montant...">

<label>Description :</label>
<textarea id="description" rows="3"></textarea>

<button id="saveBtn">Enregistrer</button>

<div id="versementContainer"></div>
</div>

<script>
const URL_GLOBAL = "https://script.google.com/macros/s/AKfycbzeLdgHnapMca_JSAM2tBOyJ4OcydK-QZXTe8ejB3kG3ueQuimjM0x3VG7eqxfoCfR0mw/exec";

document.getElementById("mobile-menu").onclick = () =>
  document.getElementById("nav-links").classList.toggle("active");

let versements = [];

// ----------------------------------------------------
// CHARGER LES DONNÉES
// ----------------------------------------------------
async function loadVersements() {
  const res = await fetch(`${URL_GLOBAL}?type=versement`);
  versements = await res.json();
  renderVersements();
}

function getMonthName(m) {
  return ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet",
          "Août","Septembre","Octobre","Novembre","Décembre"][m];
}

// Regrouper par mois
function groupByMonth(data) {
  let result = {};
  data.forEach(v => {
    let d = new Date(v.values[0]);
    let key = `${getMonthName(d.getMonth())} ${d.getFullYear()}`;
    if (!result[key]) result[key] = [];
    result[key].push(v);
  });
  return result;
}

// ----------------------------------------------------
// AFFICHAGE DU TABLEAU
// ----------------------------------------------------
function renderVersements() {
  const container = document.getElementById("versementContainer");
  container.innerHTML = "";

  const grouped = groupByMonth(versements);

  for (let month in grouped) {
    const rows = grouped[month];

    const btn = document.createElement("button");
    btn.className = "accordion-btn";
    btn.textContent = `Versements du mois : ${month}`;

    const content = document.createElement("div");
    content.className = "accordion-content";

    let html = `
      <table>
        <thead>
          <tr>
            <th>Date</th><th>Type</th><th>Montant</th>
            <th>Description</th><th>Caisse</th>
            <th>Modifier</th><th>Supprimer</th>
          </tr>
        </thead>
        <tbody>
    `;

    rows.forEach((v) => {
      html += `
        <tr>
          <td>${v.values[0]}</td>
          <td>${v.values[1]}</td>
          <td>${v.values[2]}</td>
          <td>${v.values[3]}</td>
          <td>${v.values[4]}</td>
          <td><button class="action-btn edit" onclick="editVersement(${v.row})">Modifier</button></td>
          <td><button class="action-btn delete" onclick="deleteVersement(${v.row})">Supprimer</button></td>
        </tr>
      `;
    });

    html += "</tbody></table>";
    content.innerHTML = html;

    btn.onclick = () => {
      content.style.display = content.style.display === "block" ? "none" : "block";
    };

    container.appendChild(btn);
    container.appendChild(content);
  }
}

// ----------------------------------------------------
// ENREGISTREMENT
// ----------------------------------------------------
document.getElementById("saveBtn").onclick = async () => {
  const date = document.getElementById("date").value;
  const type = document.getElementById("type").value;
  const montant = document.getElementById("montant").value;
  const description = document.getElementById("description").value;

  if (!date || !montant) {
    alert("Date et montant obligatoires");
    return;
  }

  await fetch(`${URL_GLOBAL}?type=versement`, {
    method: "POST",
    body: JSON.stringify({ date, type, montant, description })
  });

  document.getElementById("date").value = "";
  document.getElementById("montant").value = "";
  document.getElementById("description").value = "";

  loadVersements();
};

// ----------------------------------------------------
// SUPPRIMER
// ----------------------------------------------------
async function deleteVersement(row) {
  if (!confirm("Supprimer ?")) return;

  await fetch(`${URL_GLOBAL}?type=versement&action=delete&index=${row}`, {
    method: "GET"
  });

  loadVersements();
}

// ----------------------------------------------------
// MODIFIER
// ----------------------------------------------------
function editVersement(row) {
  const v = versements.find(x => x.row === row).values;

  document.getElementById("date").value = v[0];
  document.getElementById("type").value = v[1];
  document.getElementById("montant").value = v[2];
  document.getElementById("description").value = v[3];

  // replace save action
  document.getElementById("saveBtn").onclick = async () => {
    await fetch(`${URL_GLOBAL}?type=versement&edit=${row}`, {
      method: "POST",
      body: JSON.stringify({
        date: v[0],
        type: v[1],
        montant: v[2],
        description: v[3]
      })
    });

    loadVersements();

    // restore save function
    document.getElementById("saveBtn").onclick = saveVersement;
  };
}

loadVersements();
</script>

</body>
</html>
