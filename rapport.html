<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SODAMA - Rapport Mensuel</title>

<style>
body { font-family: Arial; background:#fff; color:#0a3d62; margin:0; }
.navbar { display:flex; justify-content:space-between; padding:10px 20px; background:#0a3d62; color:white; }
.navbar .logo { font-size:1.5rem; font-weight:bold; }
.navbar ul { display:flex; gap:15px; list-style:none; }
.navbar ul li a { color:white; padding:8px 15px; border-radius:5px; text-decoration:none; }
.navbar ul li a:hover { background:white; color:#0a3d62; }
.menu-toggle { display:none; flex-direction:column; cursor:pointer; }
.menu-toggle span { width:25px; height:3px; background:white; margin:3px 0; }

@media(max-width:768px){
  .menu-toggle { display:flex; }
  .navbar ul { display:none; flex-direction:column; background:#0a3d62; position:absolute; top:60px; right:0; width:200px; padding:10px; }
  .navbar ul.active { display:flex; }
}

.accordion-btn { width:95%; margin:15px auto; padding:12px; font-size:1.2rem; border:none; border-radius:8px; cursor:pointer; background:#0a3d62; color:white; text-align:left; }
.accordion-content { width:95%; display:none; margin:10px auto; padding:15px; background:white; border-radius:8px; border:2px solid #0a3d62; }

table { width:100%; border-collapse:collapse; margin-top:15px; }
th, td { border:1px solid #0a3d62; padding:10px; text-align:center; }
.total-row { background:#0a3d62; color:white; font-weight:bold; }

.flex-container { display:flex; justify-content:space-between; gap:20px; }
.block { width:48%; }
@media(max-width:900px){ .flex-container{ flex-direction:column; } .block{ width:100%; } }

.month-total { margin-top:10px; padding:10px; background:#dfeaff; border-left:5px solid #0a3d62; }
.total-global { background:#0a3d62; color:white; padding:15px; margin:30px auto; width:90%; text-align:center; border-radius:10px; font-size:1.3rem; }

#downloadPdfBtn { margin:20px auto; display:block; background:#0a3d62; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; }
</style>
</head>

<body>

<nav class="navbar">
  <div class="logo">SODAMA</div>
  <div class="menu-toggle" id="mobile-menu"><span></span><span></span><span></span></div>
  <ul id="nav-links">
    <li><a href="index.html">Accueil</a></li>
    <li><a href="ciment.html">Ciment</a></li>
    <li><a href="transport.html">Transport</a></li>
    <li><a href="rapport.html">Rapport</a></li>
    <li><a href="versement.html">Versement</a></li>
  </ul>
</nav>

<h1 style="text-align:center; margin-top:20px;">Rapport Mensuel</h1>

<button id="downloadPdfBtn">Télécharger le PDF</button>

<div id="reportContainer"></div>

<div class="total-global">
TOTAL GLOBAL BÉNÉFICE : <span id="global_benef">0</span> FCFA
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
const URL_GLOBAL = "https://script.google.com/macros/s/AKfycbzeLdgHnapMca_JSAM2tBOyJ4OcydK-QZXTe8ejB3kG3ueQuimjM0x3VG7eqxfoCfR0mw/exec";

document.getElementById("mobile-menu").onclick = () =>
  document.getElementById("nav-links").classList.toggle("active");

let cimentData = [], transportData = [];

// ------------------------------
// CHARGEMENT DES DONNÉES
// ------------------------------
async function loadData(){
  cimentData = await (await fetch(`${URL_GLOBAL}?type=ciment`)).json();
  transportData = await (await fetch(`${URL_GLOBAL}?type=transport`)).json();
  renderReport();
}

function getMonthName(m){
  return ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet",
          "Août","Septembre","Octobre","Novembre","Décembre"][m];
}

// ------------------------------
// GROUPE PAR MOIS
// ------------------------------
function groupByMonth(data){
  let result = {};
  data.forEach(item=>{
    let row = item.values;
    if(row[0] && !isNaN(new Date(row[0]).getTime())){
      let d = new Date(row[0]);
      let key = `${getMonthName(d.getMonth())} ${d.getFullYear()}`;
      if(!result[key]) result[key] = [];
      result[key].push(row);
    }
  });
  return result;
}

// ------------------------------
// RENDU DU RAPPORT
// ------------------------------
function renderReport(){
  const container = document.getElementById("reportContainer");
  container.innerHTML = "";

  const cimentByMonth = groupByMonth(cimentData);
  const transportByMonth = groupByMonth(transportData);

  const allMonths = Array.from(
      new Set([...Object.keys(cimentByMonth), ...Object.keys(transportByMonth)])
  );

  let globalBenef = 0;

  allMonths.forEach(month=>{
    const cimentRows = cimentByMonth[month] || [];
    const transportRows = transportByMonth[month] || [];

    if(cimentRows.length === 0 && transportRows.length === 0) return;

    let btn = document.createElement("button");
    btn.className = "accordion-btn";
    btn.textContent = `Rapport du mois ${month}`;

    let content = document.createElement("div");
    content.className = "accordion-content";

    let tc = { tonnage:0, depense:0, benefice:0 };
    cimentRows.forEach(x=>{
      tc.tonnage += Number(x[1]);
      tc.depense += Number(x[4]);
      tc.benefice += Number(x[5]);
      globalBenef += Number(x[5]);
    });

    let tt = { tonnage:0, depense:0, benefice:0 };
    transportRows.forEach(x=>{
      tt.tonnage += Number(x[1]);
      tt.depense += Number(x[3]);
      tt.benefice += Number(x[5]);
      globalBenef += Number(x[5]);
    });

    content.innerHTML = `
    <div class="flex-container">

      <div class="block">
      <h2>TRANSPORT</h2>
      <table>
        <tr><th>Date</th><th>Tonnage</th><th>Dépense</th><th>Bénéfice</th></tr>
        ${transportRows.map(x=>`
          <tr>
            <td>${x[0]}</td><td>${x[1]}</td><td>${x[3]}</td><td>${x[5]}</td>
          </tr>
        `).join("")}
        <tr class="total-row"><td>TOTAL</td><td>${tt.tonnage}</td><td>${tt.depense}</td><td>${tt.benefice}</td></tr>
      </table>
      </div>

      <div class="block">
      <h2>CIMENT</h2>
      <table>
        <tr><th>Date</th><th>Tonnage</th><th>Dépense</th><th>Bénéfice</th></tr>
        ${cimentRows.map(x=>`
          <tr>
            <td>${x[0]}</td><td>${x[1]}</td><td>${x[4]}</td><td>${x[5]}</td>
          </tr>
        `).join("")}
        <tr class="total-row"><td>TOTAL</td><td>${tc.tonnage}</td><td>${tc.depense}</td><td>${tc.benefice}</td></tr>
      </table>
      </div>

    </div>
    `;

    btn.onclick = ()=> content.style.display = content.style.display==="block" ? "none":"block";

    container.appendChild(btn);
    container.appendChild(content);
  });

  document.getElementById("global_benef").textContent = globalBenef;
}

// ------------------------------
// PDF
// ------------------------------
document.getElementById("downloadPdfBtn").onclick = async () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p","pt","a4");
  const element = document.getElementById("reportContainer");
  const canvas = await html2canvas(element, { scale:2 });
  const img = canvas.toDataURL("image/png");
  const pdfWidth = doc.internal.pageSize.getWidth();
  const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
  doc.addImage(img, "PNG", 0, 0, pdfWidth, pdfHeight);
  doc.save("rapport_sodama.pdf");
};

loadData();
</script>
</body>
</html>
