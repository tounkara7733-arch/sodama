<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SODAMA - Rapport</title>
<style>
body { font-family: Arial, sans-serif; margin:0; background:#ffffff; color:#0a3d62; }
.navbar { display:flex; justify-content:space-between; align-items:center; background:#0a3d62; padding:10px 20px; color:white; }
.navbar .logo { font-size:1.5rem; font-weight:bold; }
.navbar ul { display:flex; list-style:none; gap:15px; }
.navbar ul li a { text-decoration:none; color:white; padding:8px 15px; border-radius:5px; font-weight:bold; }
.navbar ul li a:hover { background:white; color:#0a3d62; }
.menu-toggle { display:none; flex-direction:column; cursor:pointer; }
.menu-toggle span { background:white; width:25px; height:3px; margin:4px 0; }
@media(max-width:768px){
  .menu-toggle{display:flex;}
  .navbar ul{position:absolute; top:60px; right:0; background:#0a3d62; width:200px; flex-direction:column; padding:10px; display:none;}
  .navbar ul.active{display:flex;}
}
h1 { text-align:center; margin:20px 0; }
h2 { width:95%; margin:20px auto 10px; }
table{width:95%; margin:10px auto 20px; border-collapse:collapse;}
th,td{border:1px solid #0a3d62; padding:8px; text-align:center;}
.summary-box{width:95%; margin:10px auto; padding:10px; border:1px solid #0a3d62; border-radius:5px; background:#f5f9ff;}
</style>
</head>
<body>

<nav class="navbar">
  <div class="logo">SODAMA</div>
  <div class="menu-toggle" id="mobile-menu"><span></span><span></span><span></span></div>
  <ul id="nav-links">
    <li><a href="index.html">Accueil</a></li>
    <li><a href="ciment.html">Ciment</a></li>
    <li><a href="transport.html">Transport</a></li>
    <li><a href="rapport.html">Rapport</a></li>
    <li><a href="versement.html">Versement</a></li>
  </ul>
</nav>

<h1>Rapport Mensuel</h1>

<div class="summary-box" id="globalSummary">
  Chargement des totaux...
</div>

<h2>Ciment - Totaux par mois</h2>
<div id="cimentReportContainer"></div>

<h2>Transport - Totaux par mois</h2>
<div id="transportReportContainer"></div>

<script>
document.getElementById("mobile-menu").onclick = () => {
  document.getElementById("nav-links").classList.toggle("active");
};

// même URL WebApp que les autres pages
const GLOBAL_URL = "https://script.google.com/macros/s/AKfycbzR-6D78_LcroRmtOjF5kNqidZ9HTAddzylWHc_eq7pfEKOESFGextkWQhr-Uxx6B1nGw/exec";

function formatFCFA(val){ return Number(val).toLocaleString('fr-FR') + " FCFA"; }
function getMonthKey(dateStr){
  const d = new Date(dateStr);
  const mois = (d.getMonth()+1).toString().padStart(2,"0");
  const annee = d.getFullYear();
  return mois + "-" + annee;
}

// ----- CHARGEMENT DES DONNÉES -----
async function loadData(){
  try{
    const [cimentRes, transportRes] = await Promise.all([
      fetch(GLOBAL_URL + "?type=ciment"),
      fetch(GLOBAL_URL + "?type=transport")
    ]);

    const cimentRows = await cimentRes.json();
    const transportRows = await transportRes.json();

    const cimentData = cimentRows.map(r=>({
      date: r.values[0],
      tonnage: parseFloat(r.values[1]) || 0,
      prixAchat: parseFloat(r.values[2]) || 0,
      prixVente: parseFloat(r.values[3]) || 0,
      depense: parseFloat(r.values[4]) || 0,
      benefice: parseFloat(r.values[5]) || ((parseFloat(r.values[3]||0)*parseFloat(r.values[1]||0)) - (parseFloat(r.values[2]||0)*parseFloat(r.values[1]||0)) - parseFloat(r.values[4]||0))
    }));

    const transportData = transportRows.map(r=>({
      date: r.values[0],
      tonnage: parseFloat(r.values[1]) || 0,
      prixUnitaire: parseFloat(r.values[2]) || 0,
      depense: parseFloat(r.values[3]) || 0,
      benefice: parseFloat(r.values[5]) || ((parseFloat(r.values[1]||0)*parseFloat(r.values[2]||0)) - parseFloat(r.values[3]||0))
    }));

    buildCimentReport(cimentData);
    buildTransportReport(transportData);
    buildGlobalSummary(cimentData, transportData);

  }catch(e){
    console.error("Erreur chargement rapport:", e);
    document.getElementById("globalSummary").textContent = "Erreur de chargement du rapport.";
  }
}

// ----- AGRÉGATION CIMENT -----
function buildCimentReport(data){
  const grouped = {};

  data.forEach(item=>{
    const key = getMonthKey(item.date);
    if(!grouped[key]){
      grouped[key] = {
        tonnage:0,
        achatTotal:0,
        venteTotal:0,
        depenseTotal:0,
        beneficeTotal:0
      };
    }
    grouped[key].tonnage += item.tonnage;
    grouped[key].achatTotal += item.prixAchat * item.tonnage;
    grouped[key].venteTotal += item.prixVente * item.tonnage;
    grouped[key].depenseTotal += item.depense;
    grouped[key].beneficeTotal += item.benefice;
  });

  const container = document.getElementById("cimentReportContainer");
  container.innerHTML = "";

  const months = Object.keys(grouped).sort((a,b)=>{
    const [ma,ya] = a.split("-").map(Number);
    const [mb,yb] = b.split("-").map(Number);
    return new Date(ya,ma-1,1) - new Date(yb,mb-1,1);
  });

  if(months.length === 0){
    container.textContent = "Aucune donnée ciment.";
    return;
  }

  let html = `<table>
  <thead>
    <tr>
      <th>Mois</th>
      <th>Tonnage total</th>
      <th>Total achats</th>
      <th>Total ventes</th>
      <th>Dépenses</th>
      <th>Bénéfice</th>
    </tr>
  </thead>
  <tbody>`;

  months.forEach(month=>{
    const m = grouped[month];
    html += `<tr>
      <td>${month}</td>
      <td>${m.tonnage}</td>
      <td>${formatFCFA(m.achatTotal)}</td>
      <td>${formatFCFA(m.venteTotal)}</td>
      <td>${formatFCFA(m.depenseTotal)}</td>
      <td>${formatFCFA(m.beneficeTotal)}</td>
    </tr>`;
  });

  html += "</tbody></table>";
  container.innerHTML = html;
}

// ----- AGRÉGATION TRANSPORT -----
function buildTransportReport(data){
  const grouped = {};

  data.forEach(item=>{
    const key = getMonthKey(item.date);
    if(!grouped[key]){
      grouped[key] = {
        tonnage:0,
        montantTotal:0,
        depenseTotal:0,
        beneficeTotal:0
      };
    }
    grouped[key].tonnage += item.tonnage;
    grouped[key].montantTotal += item.prixUnitaire * item.tonnage;
    grouped[key].depenseTotal += item.depense;
    grouped[key].beneficeTotal += item.benefice;
  });

  const container = document.getElementById("transportReportContainer");
  container.innerHTML = "";

  const months = Object.keys(grouped).sort((a,b)=>{
    const [ma,ya] = a.split("-").map(Number);
    const [mb,yb] = b.split("-").map(Number);
    return new Date(ya,ma-1,1) - new Date(yb,mb-1,1);
  });

  if(months.length === 0){
    container.textContent = "Aucune donnée transport.";
    return;
  }

  let html = `<table>
  <thead>
    <tr>
      <th>Mois</th>
      <th>Tonnage total</th>
      <th>Montant transport</th>
      <th>Dépenses</th>
      <th>Bénéfice</th>
    </tr>
  </thead>
  <tbody>`;

  months.forEach(month=>{
    const m = grouped[month];
    html += `<tr>
      <td>${month}</td>
      <td>${m.tonnage}</td>
      <td>${formatFCFA(m.montantTotal)}</td>
      <td>${formatFCFA(m.depenseTotal)}</td>
      <td>${formatFCFA(m.beneficeTotal)}</td>
    </tr>`;
  });

  html += "</tbody></table>";
  container.innerHTML = html;
}

// ----- RÉSUMÉ GLOBAL -----
function buildGlobalSummary(cimentData, transportData){
  let benefCiment = 0, benefTransport = 0;
  let depCiment = 0, depTransport = 0;

  cimentData.forEach(i=>{
    benefCiment += i.benefice;
    depCiment += i.depense;
  });
  transportData.forEach(i=>{
    benefTransport += i.benefice;
    depTransport += i.depense;
  });

  const global = document.getElementById("globalSummary");
  global.innerHTML = `
    <strong>Résumé global :</strong><br>
    Bénéfice Ciment : ${formatFCFA(benefCiment)}<br>
    Bénéfice Transport : ${formatFCFA(benefTransport)}<br>
    Bénéfice total : ${formatFCFA(benefCiment + benefTransport)}<br>
    Dépenses Ciment : ${formatFCFA(depCiment)}<br>
    Dépenses Transport : ${formatFCFA(depTransport)}
  `;
}

// lancement
loadData();
</script>

</body>
</html>
